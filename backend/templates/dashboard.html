<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dashboard - Channel Manager</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f7f8fa; margin:0; }
    table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; }
    th, td { padding:10px; text-align:left; border-bottom:1px solid #eee; }
    th { background:#f0f0f0; font-weight:600; }
    .container { max-width: 900px; margin: 40px auto; background:white; border-radius:8px; padding:20px; box-shadow:0 4px 10px rgba(0,0,0,.05);}
    .topbar { background:#0070f3; color:#fff; padding:12px 18px; display:flex; justify-content:space-between; align-items:center; }
    .topbar a { color:white; text-decoration:none; margin:0 6px; }
    button { border:none; background:#0070f3; color:white; border-radius:6px; padding:6px 12px; cursor:pointer; }
    button:hover { background:#005bd1; }
    .muted { font-size:0.85rem; color:#555; margin-top:16px; }
  </style>
</head>
<body>
  <div class="topbar">
    <div>üè† Channel Manager</div>
    <div>
      <a href="/lang/en">EN</a> | <a href="/lang/th">‡πÑ‡∏ó‡∏¢</a> |
      <a href="/logout">Logout</a>
    </div>
  </div>

  <div class="container">
    <h2>All Properties</h2>

    <!-- Actions -->
    <button onclick="checkIcalStatus()">üîç Check iCal Status</button>
    <div id="ical-results" style="margin:15px 0;font-family:monospace;"></div>

    <!-- Table -->
    <table>
      <tr>
        <th>OTA</th>
        <th>Property / Room ID</th>
        <th>Public Link</th>
        <th>iCal URL</th>
        <th>Actions</th>
      </tr>
      {% for u in units %}
      <tr>
        <td>{{ u.ota }}</td>
        <td>{{ u.property_id }}</td>
        <td><a href="/r/{{ u.id }}" target="_blank">/r/{{ u.id }}</a></td>
        <td><a href="{{ u.ical_url }}" target="_blank">open</a></td>
        <td>
          <input id="in-{{u.id}}" type="text" value="{{u.ical_url}}" style="width:60%; padding:6px;" />
          <button onclick="saveIcal({{u.id}})">Save</button>
        </td>
      </tr>
      {% endfor %}
    </table>

    <p class="muted">‚è± Background sync runs every 10 minutes ‚Äî keeps calendars auto-updated.</p>
  </div>

  <script>
  async function checkIcalStatus() {
    const resultsDiv = document.getElementById("ical-results");
    resultsDiv.innerHTML = "‚è≥ Checking all iCal links...";
    try {
      const res = await fetch("/api/check_ical");
      const data = await res.json();
      if (data.error) {
        resultsDiv.innerHTML = "‚ùå Unauthorized ‚Äî please log in again.";
        return;
      }

      let html = `
        <table style='width:100%;border-collapse:collapse;margin-top:12px;'>
          <tr style='background:#f0f0f0;'>
            <th style='text-align:left;padding:8px;'>OTA</th>
            <th style='text-align:left;padding:8px;'>Property</th>
            <th style='text-align:left;padding:8px;'>Status</th>
          </tr>
      `;

      for (let row of data) {
        let color = "#dc2626";
        if (row.status.includes("‚úÖ")) color = "#16a34a";
        else if (row.status.includes("‚ö†Ô∏è")) color = "#ca8a04";
        html += `
          <tr>
            <td style='padding:8px;border-bottom:1px solid #eee;'>${row.ota}</td>
            <td style='padding:8px;border-bottom:1px solid #eee;'>${row.property_id}</td>
            <td style='padding:8px;border-bottom:1px solid #eee;color:${color};font-weight:600;'>${row.status}</td>
          </tr>
        `;
      }
      html += "</table>";
      resultsDiv.innerHTML = html;
    } catch (err) {
      resultsDiv.innerHTML = "‚ùå Error checking iCal status:<br>" + err;
    }
  }

  async function saveIcal(id){
    const val = document.getElementById("in-"+id).value.trim();
    if(!val.match(/^https:\/\/[^\s]+$/)){
      alert("‚ö†Ô∏è Invalid iCal URL. Must start with https:// and have no spaces.");
      return;
    }

    const lower = val.toLowerCase();
    if(lower.includes("airbnb.com") || lower.includes("agoda.com")){
      if(!lower.endsWith(".ics") && !lower.includes(".ics?")){
        alert("‚ö†Ô∏è Airbnb/Agoda iCal must end with .ics or contain .ics?");
        return;
      }
    }
    if(lower.includes("booking.com") && !lower.includes("/v1/export?t=")){
      alert("‚ö†Ô∏è Booking.com iCal must contain /v1/export?t= followed by token.");
      return;
    }

    const r = await fetch(`/api/unit/${id}/ical`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ ical_url: val })
    });
    const j = await r.json();
    if(j.ok){ alert("Saved ‚úÖ"); }
    else { alert("Error: " + (j.error || "unknown")); }
  }
  </script>
</body>
</html>
