<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dashboard - Channel Manager</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="topbar">
    <div>Channel Manager</div>
    <div>
      <a href="/lang/en">EN</a> | <a href="/lang/th">‡πÑ‡∏ó‡∏¢</a> |
      <a href="/logout">Logout</a>
    </div>
  </div>

  <div class="container">
    <h2>All Units</h2>

    <!-- Actions -->
    <button onclick="checkIcalStatus()" style="background:#16a34a;color:white;padding:8px 14px;border:none;border-radius:8px;cursor:pointer;margin-bottom:12px;">
      üîç Check iCal Status
    </button>
    <div id="ical-results" style="margin-bottom:20px;font-family:system-ui,monospace;"></div>

    <!-- Table -->
    <table>
      <tr>
        <th>OTA</th>
        <th>Property / Room ID</th>
        <th>iCal</th>
      </tr>
      {% for u in units %}
      <tr>
        <td>{{u.ota}}</td>
        <td>{{u.property_id}}</td>
        <td>
          <div style="display:flex; gap:6px; align-items:center;">
            <a href="{{u.ical_url}}" target="_blank">open</a>
            <input id="in-{{u.id}}" type="text" value="{{u.ical_url}}" style="width:60%; padding:6px;" />
            <button onclick="saveIcal({{u.id}})" style="padding:6px 10px;">Save</button>
          </div>
        </td>
      </tr>
      {% endfor %}
    </table>

    <p class="muted">Background sync fetches calendars every ~2 minutes.</p>
  </div>

  <script>
  async function checkIcalStatus() {
    const resultsDiv = document.getElementById("ical-results");
    resultsDiv.innerHTML = "<div style='padding:8px;'>‚è≥ Checking all iCal links...</div>";

    try {
      const res = await fetch("/api/check_ical");
      const data = await res.json();
      if (data.error) {
        resultsDiv.innerHTML = "‚ùå Unauthorized ‚Äî please log in again.";
        return;
      }

      let html = `
        <table style='width:100%;border-collapse:collapse;margin-top:12px;'>
          <tr style='background:#f0f0f0;'>
            <th style='text-align:left;padding:8px;'>OTA</th>
            <th style='text-align:left;padding:8px;'>Property</th>
            <th style='text-align:left;padding:8px;'>Status</th>
          </tr>
      `;

      for (let row of data) {
        let color = "#dc2626"; // red default
        if (row.status.includes("‚úÖ")) color = "#16a34a"; // green
        else if (row.status.includes("‚ö†Ô∏è")) color = "#ca8a04"; // orange

        html += `
          <tr>
            <td style='padding:8px;border-bottom:1px solid #eee;'>${row.ota}</td>
            <td style='padding:8px;border-bottom:1px solid #eee;'>${row.property_id}</td>
            <td style='padding:8px;border-bottom:1px solid #eee;color:${color};font-weight:600;'>${row.status}</td>
          </tr>
        `;
      }

      html += "</table>";
      resultsDiv.innerHTML = html;
    } catch (err) {
      resultsDiv.innerHTML = "‚ùå Error checking iCal status:<br>" + err;
    }
  }

  async function saveIcal(id){
    const val = document.getElementById("in-"+id).value.trim();
    
    // ---- Strong URL validation before saving ----
  if(!val.match(/^https:\/\/[^\s]+$/)){
    alert("‚ö†Ô∏è Invalid iCal URL. It must start with https:// and contain no spaces.");
    return;
  }

  // Specific OTA pattern checks
  const lower = val.toLowerCase();
  if(lower.includes("airbnb.com") || lower.includes("agoda.com")){
    if(!lower.endsWith(".ics") && !lower.includes(".ics?")){
      alert("‚ö†Ô∏è Airbnb/Agoda iCal links must end with .ics or contain .ics? ‚Äî please recheck the full URL.");
      return;
    }
  }

  if(lower.includes("booking.com") && !lower.includes("/v1/export?t=")){
    alert("‚ö†Ô∏è Booking.com iCal must contain /v1/export?t= followed by token.");
    return;
  }
    
    const r = await fetch(`/api/unit/${id}/ical`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ ical_url: val })
    });
    const j = await r.json();
    if(j.ok){ alert("Saved ‚úÖ"); }
    else { alert("Error: " + (j.error || "unknown")); }
  }
  </script>
</body>
</html>
