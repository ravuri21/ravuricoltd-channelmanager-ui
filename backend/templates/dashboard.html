<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dashboard - Channel Manager</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    body{font-family:system-ui,Arial,Helvetica;background:#f6f8fa;margin:0}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#fff;border-bottom:1px solid #eee}
    .container{max-width:1100px;margin:18px auto;padding:16px}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
    table th, table td{padding:10px;border-bottom:1px solid #f1f1f1;text-align:left}
    .muted{color:#6b7280;font-size:.95rem}
    .btn{padding:8px 10px;border-radius:8px;background:#2563eb;color:#fff;border:none;cursor:pointer}
    .btn.small{padding:6px 8px;font-size:.9rem}
    .btn.secondary{background:#6b7280}
    .inline{display:inline-flex;gap:8px;align-items:center}
    input[type="text"]{padding:8px;border-radius:8px;border:1px solid #ddd;width:100%}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:.85rem}
  </style>
</head>
<body>
  <div class="topbar">
    <div style="font-weight:700">Channel Manager ‚Äî Admin</div>
    <div>
      <a href="/properties" target="_blank">Public index</a> |
      <a href="/lang/en">EN</a> | <a href="/lang/th">‡πÑ‡∏ó‡∏¢</a> |
      <a href="/logout">Logout</a>
    </div>
  </div>

  <div class="container">
    <h2>All Units</h2>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div class="muted">Use <b>Manage</b> to close/open dates. Toggle ‚ÄúApply to all OTAs‚Äù.</div>
      <div>
        <button onclick="checkIcalStatus()" class="btn" style="background:#16a34a;">üîç Check iCal Status</button>
      </div>
    </div>

    <div id="ical-results" style="margin-bottom:12px;font-family:system-ui,monospace;"></div>

    <table>
      <thead style="background:#fafafa">
        <tr>
          <th style="width:110px">OTA</th>
          <th>Property / Room ID</th>
          <th>Public</th>
          <th style="min-width:360px">iCal</th>
          <th style="width:180px">Price (THB)</th>
          <th style="width:120px">Availability</th>
        </tr>
      </thead>
      <tbody>
      {% for u in units %}
        <tr>
          <td>{{ u.ota }}</td>
          <td>{{ u.property_id }}</td>

          <td>
            {% if u.group_slug %}
              <a class="btn small" href="/prop/{{ u.group_slug }}" target="_blank">Public View</a>
            {% else %}
              <a class="btn small" href="/r/{{ u.id }}" target="_blank">Public Link</a>
            {% endif %}
          </td>

          <td>
            <div style="display:flex; gap:8px; align-items:center;">
              <a href="{{ u.ical_url }}" target="_blank">open</a>
              <input id="in-{{u.id}}" type="text" value="{{ u.ical_url or '' }}" style="flex:1; min-width:220px; padding:6px;" />
              <button class="btn small" onclick="saveIcal({{u.id}})">Save</button>
            </div>
          </td>

          <td>
            <div style="display:flex; gap:8px; align-items:center;">
              <input id="rate-{{u.id}}" type="number" placeholder="Price" style="width:120px; padding:6px;" />
              <button class="btn small" onclick="savePrice({{u.id}})">Save</button>
            </div>
          </td>

          <td>
            <button class="btn small" onclick="openManage({{u.id}},'{{u.ota|e}}','{{u.property_id|e}}')">Manage</button>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>

    <p class="muted" style="margin-top:10px">Background sync fetches calendars every ~10 minutes.</p>
  </div>

  <!-- Manage Modal -->
  <div id="backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9999">
    <div style="width:min(820px,96vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden">
      <header style="padding:12px 16px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between">
        <h3 id="m-title" style="margin:0;font-size:1.05rem">Manage Availability</h3>
        <button class="btn secondary" onclick="closeManage()">‚úï</button>
      </header>
      <div style="padding:14px 16px">
        <div style="display:flex;gap:8px;align-items:center;margin:8px 0">
          <span class="pill" id="m-pill"></span>
          <span class="muted" id="m-sub" style="margin-left:8px;"></span>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin:8px 0">
          <label style="display:inline-flex;align-items:center;gap:8px;">
            <input type="checkbox" id="m-group">
            <span>Apply to <b>all OTAs</b> in this property</span>
          </label>
          <span id="m-group-info" class="muted" style="margin-left:10px"></span>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin:8px 0">
          <input id="m-start" type="date" />
          <input id="m-end" type="date" />
          <input id="m-note" type="text" placeholder="Note (optional)" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:8px" />
          <button class="btn" onclick="addBlock()">‚ûï Block dates</button>
        </div>
        <div class="muted">Block creates a hold from check-in (start) to check-out (end).</div>

        <h4 style="margin:14px 0 6px;">Existing Blocks (this unit)</h4>
        <table style="width:100%;border-collapse:collapse;margin-top:10px">
          <thead>
            <tr style="background:#fafafa">
              <th style="padding:8px;text-align:left">ID</th>
              <th style="padding:8px;text-align:left">Start</th>
              <th style="padding:8px;text-align:left">End</th>
              <th style="padding:8px;text-align:left">Source</th>
              <th style="padding:8px;text-align:left">Note</th>
              <th style="padding:8px;text-align:left"></th>
            </tr>
          </thead>
          <tbody id="m-rows">
            <tr><td colspan="6" class="muted" style="padding:8px">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  async function checkIcalStatus() {
    const resultsDiv = document.getElementById("ical-results");
    resultsDiv.innerHTML = "<div style='padding:8px;'>‚è≥ Checking all iCal links...</div>";
    try {
      const res = await fetch("/api/check_ical");
      const data = await res.json();
      if (data.error) { resultsDiv.innerHTML = "‚ùå Unauthorized ‚Äî please log in again."; return; }
      let html = `
        <table style='width:100%;border-collapse:collapse;margin-top:12px;'>
          <tr style='background:#f0f0f0;'>
            <th style='text-align:left;padding:8px;'>OTA</th>
            <th style='text-align:left;padding:8px;'>Property</th>
            <th style='text-align:left;padding:8px;'>Status</th>
          </tr>`;
      for (let row of data) {
        let color = "#dc2626";
        if (row.status.includes("‚úÖ")) color = "#16a34a";
        else if (row.status.includes("‚ö†Ô∏è")) color = "#ca8a04";
        html += `
          <tr>
            <td style='padding:8px;border-bottom:1px solid #eee;'>${row.ota}</td>
            <td style='padding:8px;border-bottom:1px solid #eee;'>${row.property_id}</td>
            <td style='padding:8px;border-bottom:1px solid #eee;color:${color};font-weight:600;'>${row.status}</td>
          </tr>`;
      }
      html += "</table>";
      resultsDiv.innerHTML = html;
    } catch (err) {
      resultsDiv.innerHTML = "‚ùå Error checking iCal status:<br>" + err;
    }
  }

  async function saveIcal(id){
    const val = document.getElementById("in-"+id).value.trim();
    if(!val){ alert("‚ö†Ô∏è Enter iCal URL or clear to remove."); return; }
    const lower = val.toLowerCase();
    if((lower.includes("airbnb.com") || lower.includes("agoda.com")) && !lower.includes(".ics")){
      alert("‚ö†Ô∏è Airbnb/Agoda iCal should include .ics"); return;
    }
    if(lower.includes("booking.com") && !lower.includes("/v1/export?t=")){
      alert("‚ö†Ô∏è Booking.com iCal should include /v1/export?t="); return;
    }
    const r = await fetch(`/api/unit/${id}/ical`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ ical_url: val })
    });
    const j = await r.json();
    alert(j.ok ? "Saved ‚úÖ" : ("Error: " + (j.error || "unknown")));
  }

  async function savePrice(unitId){
    const v = document.getElementById("rate-"+unitId).value.trim();
    if(!v || isNaN(v)){ alert("Enter a valid number"); return; }
    const r = await fetch("/api/rates", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ unit_id: unitId, base_rate: parseFloat(v), currency: "THB" })
    });
    const j = await r.json();
    alert(j.ok ? "Price saved ‚úÖ" : ("Error: " + (j.error || "unknown")));
  }

  // Manage modal logic (same as before) -----------------
  let currentUnitId = null;
  let currentSlug = null;
  let currentGroupIds = [];

  function todayISO(){
    const t = new Date();
    return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;
  }

  async function openManage(unitId, ota, propId){
    currentUnitId = unitId; currentSlug = null; currentGroupIds = [];
    document.getElementById("m-title").textContent = "Manage Availability";
    document.getElementById("m-pill").textContent = `${ota}`;
    document.getElementById("m-sub").textContent = propId;
    const s = document.getElementById("m-start");
    const e = document.getElementById("m-end");
    const min = todayISO(); s.min = min; e.min = min; s.value = ""; e.value = "";
    document.getElementById("m-note").value = "";
    document.getElementById("m-group").checked = false;
    document.getElementById("m-group-info").textContent = "Detecting property group‚Ä¶";

    try{
      const r = await fetch(`/api/admin/find_group?unit_id=${unitId}`);
      const j = await r.json();
      if(j.ok){
        currentSlug = j.slug; currentGroupIds = j.unit_ids || [];
        document.getElementById("m-group-info").textContent = `Property: ${j.title || j.slug} ‚Äî Units: ${currentGroupIds.join(", ")}`;
      }else{
        document.getElementById("m-group-info").textContent = "This unit is not mapped to a property group.";
      }
    }catch(_){
      document.getElementById("m-group-info").textContent = "Group lookup failed.";
    }

    loadBlocks();
    document.getElementById("backdrop").style.display = "flex";
  }

  function closeManage(){
    currentUnitId = null; currentSlug = null; currentGroupIds = [];
    document.getElementById("backdrop").style.display = "none";
  }

  async function loadBlocks(){
    const tbody = document.getElementById("m-rows");
    tbody.innerHTML = `<tr><td colspan="6" class="muted" style="padding:8px">Loading‚Ä¶</td></tr>`;
    try{
      const r = await fetch(`/api/blocks?unit_id=${currentUnitId}`);
      const data = await r.json();
      if(!Array.isArray(data) || !data.length){
        tbody.innerHTML = `<tr><td colspan="6" class="muted" style="padding:8px">No blocks</td></tr>`;
        return;
      }
      tbody.innerHTML = data.map(b => `
        <tr>
          <td style="padding:8px;">${b.id}</td>
          <td style="padding:8px;">${b.start_date}</td>
          <td style="padding:8px;">${b.end_date}</td>
          <td style="padding:8px;">${b.source || ''}</td>
          <td style="padding:8px;">${b.note || ''}</td>
          <td style="padding:8px;"><button class="btn small" style="background:#dc2626" onclick="delBlock(${b.id})">Delete</button></td>
        </tr>
      `).join("");
    }catch(err){
      tbody.innerHTML = `<tr><td colspan="6" class="muted" style="padding:8px">Error loading blocks</td></tr>`;
    }
  }

  async function addBlock(){
    const s = document.getElementById("m-start").value;
    const e = document.getElementById("m-end").value;
    const note = document.getElementById("m-note").value.trim() || "manual";
    if(!s || !e){ alert("Pick start and end dates"); return; }
    if(e <= s){ alert("Check-out must be after check-in"); return; }

    const applyGroup = document.getElementById("m-group").checked && currentSlug;

    try{
      if(applyGroup){
        const r = await fetch(`/api/admin/block_group/${currentSlug}`,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ start_date: s, end_date: e, note })
        });
        const j = await r.json();
        if(!(r.ok && j.ok)) throw new Error(j.error || "Group block failed");
      }else{
        const r = await fetch("/api/blocks",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            unit_id: currentUnitId, start_date: s, end_date: e,
            source: "manual", note
          })
        });
        const j = await r.json();
        if(!(r.ok && j.ok)) throw new Error(j.error || "Block failed");
      }
      loadBlocks();
      alert(applyGroup ? "Blocked for ALL OTAs ‚úÖ" : "Blocked ‚úÖ");
    }catch(err){
      alert("Error: " + err.message);
    }
  }

  async function delBlock(id){
    if(!confirm("Delete this block? This will open those dates for this unit.")) return;
    try{
      const r = await fetch(`/api/blocks?id=${id}`, { method:"DELETE" });
      const j = await r.json();
      if(r.ok && j.ok){ loadBlocks(); } else { alert(j.error || "Delete failed"); }
    }catch(err){
      alert("Network error");
    }
  }
</script>
</body>
</html>
