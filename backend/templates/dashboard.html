<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin Dashboard ‚Äî Channel Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    body{font-family:system-ui,Arial,sans-serif;background:#f6f8fa;margin:0;padding:0}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:#fff;border-bottom:1px solid #eee}
    .brand{font-weight:700}
    .container{max-width:1200px;margin:18px auto;padding:16px}
    h2{margin:0 0 8px}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .btn{background:#2563eb;color:#fff;padding:8px 12px;border:none;border-radius:8px;cursor:pointer}
    .btn.secondary{background:#6b7280}
    .muted{color:#6b7280}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.04)}
    th,td{padding:10px;border-bottom:1px solid #f1f1f1;text-align:left;font-size:.95rem}
    th{background:#fafafa;font-weight:700}
    tr:hover td{background:#fbfdff}
    input[type=text], input[type=number]{padding:8px;border:1px solid #e6e6e6;border-radius:8px;width:100%}
    .small{padding:6px 8px;font-size:.9rem}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#1e40af;font-weight:600;font-size:.85rem}
    .status-ok{color:#16a34a;font-weight:700}
    .status-warn{color:#ca8a04;font-weight:700}
    .status-err{color:#dc2626;font-weight:700}
    .actions{display:flex;gap:8px;align-items:center}
    .muted-small{color:#9aa0a6;font-size:.85rem}
    .note{color:#666;font-size:. nine rem}
    .right{display:flex;gap:8px;align-items:center}
    .table-scroll{overflow:auto;border-radius:8px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Channel Manager ‚Äî Admin</div>
    <div class="right">
      <a href="/properties" target="_blank" class="muted">View public</a> |
      <a href="/admin/groups" class="muted">Grouped Admin</a> |
      <a href="/logout" class="muted">Logout</a>
    </div>
  </div>

  <div class="container">
    <h2>All Units <span class="muted" style="font-weight:600">(internal IDs shown)</span></h2>

    <div class="controls">
      <button id="syncAll" class="btn">üîÑ Sync All OTAs Now</button>
      <button id="checkIcal" class="btn secondary">üîç Check iCal Status</button>
      <div id="lastResult" class="muted" style="margin-left:8px">Last: ‚Äî</div>
      <div style="margin-left:auto" class="muted-small">Admin: {{ t.brand }} ‚Ä¢ support: {{ t.support_email }}</div>
    </div>

    <div id="icalResults" style="margin-bottom:10px;font-family:system-ui,monospace;"></div>

    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th style="width:60px">Unit</th>
            <th style="width:120px">OTA</th>
            <th>Property / Room ID</th>
            <th style="min-width:160px">Public</th>
            <th style="min-width:360px">iCal URL</th>
            <th style="width:140px">Price ({{ currency_map.get(units[0].id, 'THB') if units else 'THB' }})</th>
            <th style="width:140px">Availability</th>
            <th style="width:160px">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for u in units %}
          <tr>
            <td style="font-weight:700">/r/{{ u.id }}</td>
            <td>{{ u.ota }}</td>
            <td style="max-width:240px;white-space:normal;">{{ u.property_id }}</td>

            <td>
              <a href="/r/{{ u.id }}" target="_blank">open</a>
            </td>

            <td>
              <div style="display:flex;gap:8px;align-items:center;">
                <input id="ical-{{ u.id }}" type="text" value="{{ u.ical_url or '' }}" placeholder="iCal URL (https://...)" />
                <button class="btn small" onclick="saveIcal({{ u.id }})">Save</button>
              </div>
            </td>

            <!-- REPLACED PRICE INPUT: only this block was updated to be mobile-friendly and always show current value -->
            <td>
              <div style="display:flex;gap:8px;align-items:center;">
                <!-- numeric input that always prints the current value and is mobile-friendly -->
                <input
                  id="rate-{{ u.id }}"
                  type="number"
                  inputmode="numeric"
                  step="1"
                  min="0"
                  placeholder="Price"
                  value="{{ rates_map.get(u.id, '') }}"
                  style="width:110px;padding:8px;border:1px solid #e6e6e6;border-radius:8px"
                />
                <button class="btn small" onclick="savePrice({{ u.id }})">Save</button>
              </div>
            </td>
            <!-- END REPLACED PRICE INPUT -->

            <td>
              <div class="muted-small">Blocks: <span id="blocks-{{ u.id }}">‚Äî</span></div>
              <div style="margin-top:6px">
                <button class="btn small secondary" onclick="openManage({{ u.id }}, '{{ u.ota|e }}', '{{ u.property_id|e }}')">Manage</button>
              </div>
            </td>

            <td class="actions">
              <button class="btn small" onclick="fetchIcalPreview({{ u.id }})">Preview</button>
              <a class="btn small secondary" href="/ical/export/{{ u.id }}.ics" target="_blank">Export iCal</a>
              <a class="btn small secondary" href="/admin/groups">Group</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <p class="muted" style="margin-top:12px">Tip: use <strong>Manage</strong> to create manual blocks which will be applied across all OTAs for a property (via grouped admin).</p>
  </div>

  <!-- Manage modal (same UI as earlier Manage modal) -->
  <div id="backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9999">
    <div style="width:min(880px,96vw);background:#fff;border-radius:12px;overflow:hidden">
      <header style="padding:12px 16px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between">
        <h3 id="m-title" style="margin:0">Manage Availability</h3>
        <button class="btn secondary" onclick="closeManage()">‚úï</button>
      </header>
      <div style="padding:12px 16px">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
          <span class="pill" id="m-pill">OTA</span>
          <div id="m-sub" class="muted" style="margin-left:8px"></div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <label style="display:inline-flex;align-items:center;gap:8px">
            <input type="checkbox" id="m-group" /> Apply to <b>all OTAs</b>
          </label>
          <div id="m-group-info" class="muted-small">Detecting property group‚Ä¶</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input id="m-start" type="date" />
          <input id="m-end" type="date" />
          <input id="m-note" type="text" placeholder="Note (optional)" style="flex:1;padding:8px;border:1px solid #e6e6e6;border-radius:8px" />
          <button class="btn" onclick="addBlock()">‚ûï Block dates</button>
        </div>

        <div style="margin-top:12px">
          <h4 style="margin:8px 0">Existing Blocks</h4>
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr><th style="text-align:left;padding:6px">ID</th><th style="padding:6px">Start</th><th style="padding:6px">End</th><th style="padding:6px">Source</th><th style="padding:6px">Note</th><th></th></tr>
            </thead>
            <tbody id="m-rows">
              <tr><td colspan="6" class="muted">Loading‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- Helpers ----------
  function setLast(msg){
    const el = document.getElementById("lastResult");
    if(el) el.textContent = "Last: " + msg;
  }

  async function checkIcalStatus(){
    const out = document.getElementById("icalResults");
    out.innerHTML = "‚è≥ Checking all iCal links...";
    try{
      const r = await fetch("/api/check_ical");
      const j = await r.json();
      if(j.error){ out.innerHTML = "‚ùå " + j.error; return; }
      let html = "<table style='width:100%;border-collapse:collapse'><tr style='background:#f9fafb'><th style='padding:8px'>OTA</th><th style='padding:8px'>Property</th><th style='padding:8px'>Status</th></tr>";
      for(const row of j){
        let color = "#dc2626";
        if(row.status.includes("‚úÖ")) color = "#16a34a";
        else if(row.status.includes("‚ö†Ô∏è")) color = "#ca8a04";
        html += `<tr><td style='padding:8px;border-bottom:1px solid #f1f1f1'>${row.ota}</td><td style='padding:8px;border-bottom:1px solid #f1f1f1'>${row.property_id}</td><td style='padding:8px;border-bottom:1px solid #f1f1f1;color:${color};font-weight:700'>${row.status}</td></tr>`;
      }
      html += "</table>";
      out.innerHTML = html;
      setLast("iCal checked");
    }catch(err){
      out.innerHTML = "‚ùå Error: " + err;
      setLast("iCal check failed");
    }
  }

  async function saveIcal(id){
    const val = document.getElementById("ical-"+id).value.trim();
    if(!val){ alert("Enter iCal URL"); return; }
    try{
      const r = await fetch(`/api/unit/${id}/ical`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ ical_url: val })
      });
      const j = await r.json();
      if(r.ok && j.ok){ alert("iCal saved ‚úÖ"); setLast("iCal saved for /r/"+id); }
      else alert("Error: " + (j.error || "unknown"));
    }catch(e){
      alert("Network error");
    }
  }

  async function savePrice(unitId){
    const el = document.getElementById("rate-"+unitId);
    const v = el.value.trim();
    if(!v || isNaN(v)){ alert("Enter a valid number"); return; }
    try{
      const r = await fetch("/api/rates", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ unit_id: unitId, base_rate: parseFloat(v), currency: "THB" })
      });
      const j = await r.json();
      if(r.ok && j.ok){ alert("Price saved ‚úÖ"); setLast("Price saved for /r/"+unitId); }
      else alert("Error: " + (j.error || "unknown"));
    }catch(e){
      alert("Network error");
    }
  }

  // ---------- Manage modal ----------
  let currentUnitId = null;
  let currentSlug = null;
  let currentGroupIds = [];

  function todayISO(){
    const t = new Date();
    return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;
  }

  async function openManage(unitId, ota, propId){
    currentUnitId = unitId;
    document.getElementById("m-title").textContent = "Manage Availability";
    document.getElementById("m-pill").textContent = ota;
    document.getElementById("m-sub").textContent = propId;
    document.getElementById("m-start").min = todayISO();
    document.getElementById("m-end").min = todayISO();
    document.getElementById("m-note").value = "";
    document.getElementById("m-group").checked = false;
    document.getElementById("m-group-info").textContent = "Detecting property group‚Ä¶";
    // find group
    try{
      const r = await fetch(`/api/admin/find_group?unit_id=${unitId}`);
      const j = await r.json();
      if(j.ok){
        currentSlug = j.slug; currentGroupIds = j.unit_ids || [];
        document.getElementById("m-group-info").textContent = `Property: ${j.title || j.slug} ‚Äî Units: ${currentGroupIds.join(", ")}`;
      }else{
        document.getElementById("m-group-info").textContent = "Not mapped to a property group.";
      }
    }catch(_){
      document.getElementById("m-group-info").textContent = "Group lookup failed.";
    }
    loadBlocks();
    document.getElementById("backdrop").style.display = "flex";
  }

  function closeManage(){
    currentUnitId = null; currentSlug = null; currentGroupIds = [];
    document.getElementById("backdrop").style.display = "none";
  }

  async function loadBlocks(){
    const tbody = document.getElementById("m-rows");
    tbody.innerHTML = `<tr><td colspan="6" class="muted">Loading‚Ä¶</td></tr>`;
    try{
      const r = await fetch(`/api/blocks?unit_id=${currentUnitId}`);
      const data = await r.json();
      if(!Array.isArray(data) || !data.length){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">No blocks</td></tr>`;
        return;
      }
      tbody.innerHTML = data.map(b => `
        <tr>
          <td style="padding:6px">${b.id}</td>
          <td style="padding:6px">${b.start_date}</td>
          <td style="padding:6px">${b.end_date}</td>
          <td style="padding:6px">${b.source || ''}</td>
          <td style="padding:6px">${b.note || ''}</td>
          <td style="padding:6px"><button class="btn small" onclick="delBlock(${b.id})">Delete</button></td>
        </tr>
      `).join("");
    }catch(err){
      tbody.innerHTML = `<tr><td colspan="6" class="muted">Error loading blocks</td></tr>`;
    }
  }

  async function addBlock(){
    const s = document.getElementById("m-start").value;
    const e = document.getElementById("m-end").value;
    const note = document.getElementById("m-note").value.trim() || "manual";
    if(!s || !e){ alert("Pick start and end"); return; }
    if(e <= s){ alert("Check-out must be after check-in"); return; }
    const applyGroup = document.getElementById("m-group").checked && currentSlug;
    try{
      if(applyGroup){
        const r = await fetch(`/api/admin/sync_property/${currentSlug}`, { method:"POST" });
        // we intentionally don't reuse sync_property for block ‚Äî do group block using admin/block_group endpoint if implemented
      }
      if(applyGroup){
        const resp = await fetch(`/api/admin/block_group/${currentSlug}`, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ start_date:s, end_date:e, note })
        });
        const j = await resp.json();
        if(!(resp.ok && j.ok)) throw new Error(j.error || "Group block failed");
      }else{
        const resp = await fetch("/api/blocks", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ unit_id: currentUnitId, start_date: s, end_date: e, source: "manual", note })
        });
        const j = await resp.json();
        if(!(resp.ok && j.ok)) throw new Error(j.error || "Block failed");
      }
      loadBlocks();
      alert("Blocked ‚úÖ");
    }catch(err){
      alert("Error: " + (err.message || err));
    }
  }

  async function delBlock(id){
    if(!confirm("Delete this block?")) return;
    try{
      const r = await fetch(`/api/blocks?id=${id}`, { method:"DELETE" });
      const j = await r.json();
      if(r.ok && j.ok) loadBlocks(); else alert(j.error || "Delete failed");
    }catch(e){ alert("Network error"); }
  }

  // ---------- Misc admin functions ----------
  async function fetchIcalPreview(id){
    const url = document.getElementById("ical-"+id).value.trim();
    if(!url){ alert("No iCal URL"); return; }
    try{
      const r = await fetch(url, { method:"GET" });
      const text = await r.text();
      alert((text || "").slice(0,1200) || "No response or blocked by CORS");
    }catch(e){
      alert("Fetch error (CORS or bad URL)");
    }
  }

  // Sync all OTAs
  document.getElementById("syncAll").addEventListener("click", async () => {
    if(!confirm("Run a full OTA sync now? This may take a minute.")) return;
    setLast("Syncing‚Ä¶");
    try{
      const r = await fetch("/api/admin/sync_now", { method: "POST" });
      const j = await r.json();
      if(r.ok && j.ok){
        setLast("Sync OK");
        checkIcalStatus();
        alert("Sync completed ‚úÖ");
      }else{
        setLast("Sync failed");
        alert("Sync error: " + (j.error || "unknown"));
      }
    }catch(e){
      setLast("Sync error");
      alert("Network error during sync");
    }
  });

  document.getElementById("checkIcal").addEventListener("click", checkIcalStatus);

  // init ‚Äî show blocks count for each unit
  (function initBlocksSummary(){
    const unitIds = [{% for u in units %}{{ u.id }},{% endfor %}];
    unitIds.forEach(async id => {
      try{
        const r = await fetch(`/api/blocks?unit_id=${id}`);
        const j = await r.json();
        if(Array.isArray(j)) document.getElementById("blocks-"+id).textContent = j.length;
        else document.getElementById("blocks-"+id).textContent = "‚Äî";
      }catch(e){
        document.getElementById("blocks-"+id).textContent = "‚Äî";
      }
    });
  })();
</script>
</body>
</html>
