<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ title }} ‚Äî Admin Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      background:#f9fafb;
      color:#111;
      margin:0;
      padding:0;
    }
    .wrap {
      max-width: 980px;
      margin: 20px auto;
      background:#fff;
      border-radius:12px;
      padding:20px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
    }
    h1 { margin:0 0 6px; font-size:1.4rem; }
    .muted { color:#666; font-size:.9rem; }
    .calendar {
      margin-top:20px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap:14px;
    }
    .month {
      border:1px solid #e5e7eb;
      border-radius:8px;
      overflow:hidden;
      background:#fafafa;
    }
    .month h3 {
      margin:0;
      padding:8px 10px;
      font-size:.95rem;
      background:#f3f4f6;
      border-bottom:1px solid #e5e7eb;
    }
    .grid {
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      border-top:1px solid #e5e7eb;
    }
    .cell, .dow {
      padding:8px;
      text-align:center;
      border-bottom:1px solid #e5e7eb;
      border-right:1px solid #e5e7eb;
      font-size:.9rem;
      user-select:none;
    }
    .dow { background:#f9fafb; font-weight:600; }
    .cell.ok { background:#ecfdf5; cursor:pointer; }
    .cell.bad { background:#fee2e2; color:#991b1b; cursor:not-allowed; }
    .cell.manual { background:#e0f2fe; color:#1e3a8a; }
    .cell.sel { outline:2px solid #60a5fa; }
    .cell:hover.ok { background:#d1fae5; }
    .grid > *:nth-child(7n){ border-right:none; }

    .legend {
      display:flex;
      gap:12px;
      align-items:center;
      font-size:.9rem;
      margin-top:10px;
    }
    .dot {
      width:12px;
      height:12px;
      border-radius:3px;
      display:inline-block;
    }
    .d-ok { background:#ecfdf5; border:1px solid #a7f3d0; }
    .d-bad { background:#fee2e2; border:1px solid #fecaca; }
    .d-manual { background:#e0f2fe; border:1px solid #93c5fd; }

    /* sync button + toast */
    .btn {
      background:#0070f3;
      color:#fff;
      border:none;
      border-radius:6px;
      padding:8px 14px;
      font-weight:600;
      cursor:pointer;
      transition:background .2s;
    }
    .btn:hover { background:#0366d6; }
    .toast {
      position:fixed;
      bottom:20px;
      right:20px;
      background:#10b981;
      color:white;
      padding:12px 18px;
      border-radius:8px;
      font-weight:600;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
      opacity:0;
      transform:translateY(20px);
      transition:all .4s ease;
      z-index:999;
    }
    .toast.show {
      opacity:1;
      transform:translateY(0);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>{{ title }}</h1>
    <div class="muted">
      Slug: {{ slug }} ‚Ä¢ Units: {{ unit_ids|join(', ') }}
      <span id="lastSync" style="margin-left:12px;color:#111;font-weight:600">‚Ä¢ Last sync: ‚Äî</span>
    </div>
    <div style="margin-top:8px;">
      <button id="syncAllBtn" class="btn">üîÑ Sync All OTA Now</button>
      <a href="/properties" target="_blank" style="margin-left:10px;font-size:.9rem;">üåê View Public Page</a>
    </div>

    <div id="calendar" class="calendar"></div>

    <div class="legend">
      <span class="dot d-ok"></span> Available
      <span class="dot d-bad"></span> Booked
      <span class="dot d-manual"></span> Manual Block
    </div>
  </div>

  <div id="toast" class="toast">Sync completed successfully!</div>

  <script>
    const SLUG = "{{ slug }}";

    function showToast(msg, color="#10b981") {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.background = color;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 3500);
    }

    function _formatIsoLocal(iso) {
      try {
        const d = new Date(iso);
        if (isNaN(d)) return iso;
        return d.toLocaleString();
      } catch (e) { return iso; }
    }

    async function fetchLastSync() {
      const el = document.getElementById("lastSync");
      if (!el) return;
      el.textContent = "‚Ä¢ Last sync: loading‚Ä¶";
      try {
        const r = await fetch(`/api/admin/last_sync/${encodeURIComponent(SLUG)}`);
        const j = await r.json();
        if (r.ok && j.ok) {
          const val = j.last_sync ? _formatIsoLocal(j.last_sync) : "never";
          el.textContent = "‚Ä¢ Last sync: " + val;
        } else {
          el.textContent = "‚Ä¢ Last sync: error";
        }
      } catch (e) {
        console.error(e);
        el.textContent = "‚Ä¢ Last sync: error";
      }
    }

    async function adminSyncAll() {
      const el = document.getElementById("lastSync");
      if (el) el.textContent = "‚Ä¢ Syncing all OTAs‚Ä¶";
      try {
        const r = await fetch("/api/admin/sync_all", { method: "POST" });
        const j = await r.json();
        if (r.ok && j.ok) {
          if (el) el.textContent = "‚Ä¢ Sync complete! Refreshing timestamp‚Ä¶";
          await fetchLastSync();
          showToast("‚úÖ OTA synchronization completed!");
        } else {
          showToast("‚ùå Sync failed!", "#ef4444");
          if (el) el.textContent = "‚Ä¢ Last sync: failed";
        }
      } catch (err) {
        console.error("Sync all error:", err);
        showToast("‚ùå Sync error!", "#ef4444");
        if (el) el.textContent = "‚Ä¢ Last sync: error";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      fetchLastSync();
      const btn = document.getElementById("syncAllBtn");
      if (btn) btn.addEventListener("click", () => adminSyncAll());
    });
  </script>
</body>
</html>
