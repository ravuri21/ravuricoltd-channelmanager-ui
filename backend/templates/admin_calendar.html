<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin Calendar — {{ title }}</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    .wrap{max-width:980px;margin:18px auto;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);overflow:hidden}
    .head{padding:12px 16px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between}
    .muted{color:#6b7280}
    .calwrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;padding:16px}
    .cal{border:1px solid #eee;border-radius:10px;overflow:hidden;background:#fafafa}
    .cal h3{margin:0;padding:8px 10px;background:#f3f4f6;border-bottom:1px solid #eee;font-size:.95rem}
    .grid{display:grid;grid-template-columns:repeat(7,1fr)}
    .dow,.cell{padding:10px;text-align:center;border-bottom:1px solid #f1f1f1;border-right:1px solid #f1f1f1;user-select:none}
    .grid>*:nth-child(7n){border-right:none}
    .dow{background:#fafafa;font-weight:600;font-size:.85rem}
    .cell.dis{color:#bbb;background:#fafafa;cursor:not-allowed}
    .cell.ok{background:#ecfdf5;border-bottom-color:#a7f3d0;cursor:pointer}
    .cell.bad{background:#fef2f2;border-bottom-color:#fecaca;color:#991b1b;cursor:pointer}
    .legend{display:flex;gap:12px;align-items:center;padding:0 16px 16px}
    .dot{width:12px;height:12px;border-radius:3px;display:inline-block}
    .okd{background:#ecfdf5;border:1px solid #a7f3d0}
    .badd{background:#fef2f2;border:1px solid #fecaca}
    .msg{margin:10px 16px;padding:10px;border-radius:8px;display:none}
    .ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .err{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border:none;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer}
    .btn.secondary{background:#6b7280}
  </style>
</head>
<body>
  <div class="topbar">
    <div>Channel Manager — Admin Calendar</div>
    <div>
      <a href="/">Admin (All 27)</a> |
      <a href="/admin/groups">Grouped Admin</a> |
      <a href="/logout">Logout</a>
    </div>
  </div>

  <div class="wrap">
    <div class="head">
      <div>
        <div style="font-weight:700">{{ title }}</div>
        <div class="muted">Slug: {{ slug }} • Units: {{ unit_ids|join(', ') }}</div>
      </div>
      <div class="actions">
        <button class="btn secondary" onclick="window.history.back()">← Back</button>
        <a class="btn" href="/prop/{{ slug }}" target="_blank">View Public Page</a>
      </div>
    </div>

    <div id="msg" class="msg"></div>

    <div class="calwrap" id="calwrap"></div>
    <div class="legend">
      <span class="dot okd"></span> Available (click to BLOCK that day)
      <span class="dot badd"></span> Blocked (click to UNBLOCK that day)
    </div>
    <div class="muted" style="padding:0 16px 16px">Tip: Blocks are single-day holds (checkout next day). Click multiple days to add/remove quickly.</div>
  </div>

<script>
const slug = "{{ slug }}";
function ymd(d){ const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}` }
function addDays(dt, n){ const d=new Date(dt); d.setDate(d.getDate()+n); return d; }

let blocked = new Set(); // booked days (YYYY-MM-DD)
const monthsToShow = 2;

function setMsg(t,ok=false){
  const m=document.getElementById("msg");
  if(!t){ m.style.display="none"; return; }
  m.textContent=t; m.className="msg "+(ok?"ok":"err"); m.style.display="block";
}

function expandRanges(ranges){
  const s=new Set();
  for(const r of ranges){
    let d=new Date(r.start_date);
    const end=new Date(r.end_date);
    while(d<end){ s.add(ymd(d)); d=addDays(d,1); }
  }
  return s;
}

async function loadAvailability(){
  setMsg("Loading availability…", true);
  try{
    const r=await fetch(`/api/public/availability/${slug}`);
    const data=await r.json();
    blocked = Array.isArray(data) ? expandRanges(data) : new Set();
    renderCalendars();
    setMsg("Loaded.", true); setTimeout(()=>setMsg(""),800);
  }catch(e){
    setMsg("Failed to load availability.");
  }
}

function buildMonth(year,month){
  const wrap=document.createElement("div");
  wrap.className="cal";
  wrap.innerHTML=`<h3>${new Date(year,month,1).toLocaleString('default',{month:'long',year:'numeric'})}</h3><div class="grid"></div>`;
  const grid=wrap.querySelector(".grid");
  const dows=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  dows.forEach(d=>{ const el=document.createElement("div"); el.className="dow"; el.textContent=d; grid.appendChild(el); });
  const startDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  for(let i=0;i<startDay;i++){ const el=document.createElement("div"); el.className="cell dis"; grid.appendChild(el); }
  for(let day=1; day<=daysInMonth; day++){
    const el=document.createElement("div");
    const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const isBlocked=blocked.has(dateStr);
    el.className="cell "+(isBlocked?"bad":"ok");
    el.textContent=day;
    el.title = isBlocked ? "Click to UNBLOCK" : "Click to BLOCK";
    el.addEventListener("click",()=>toggleDay(dateStr,isBlocked));
    grid.appendChild(el);
  }
  return wrap;
}

function renderCalendars(){
  const holder=document.getElementById("calwrap");
  holder.innerHTML="";
  const now=new Date();
  for(let m=0;m<monthsToShow;m++){
    const dt=new Date(now.getFullYear(),now.getMonth()+m,1);
    holder.appendChild(buildMonth(dt.getFullYear(),dt.getMonth()));
  }
}

async function toggleDay(dateStr,isCurrentlyBlocked){
  try{
    const r=await fetch(`/api/admin/toggle_day/${slug}`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ date: dateStr, action: isCurrentlyBlocked ? "unblock" : "block" })
    });
    const j=await r.json();
    if(!(r.ok && j.ok)) throw new Error(j.error||"Error");
    if(isCurrentlyBlocked) blocked.delete(dateStr); else blocked.add(dateStr);
    renderCalendars();
    setMsg(isCurrentlyBlocked?"Opened that date ✅":"Blocked that date ✅", true);
    setTimeout(()=>setMsg(""),800);
  }catch(e){
    setMsg("Failed: "+(e.message||e));
  }
}

// init
loadAvailability();
</script>
</body>
</html>
