<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin Calendar ‚Äî {{ title }}</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    .wrap{max-width:980px;margin:18px auto;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);overflow:hidden}
    .head{padding:12px 16px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between}
    .muted{color:#6b7280}
    .calwrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;padding:16px}
    .cal{border:1px solid #eee;border-radius:10px;overflow:hidden;background:#fafafa}
    .cal h3{margin:0;padding:8px 10px;background:#f3f4f6;border-bottom:1px solid #eee;font-size:.95rem}
    .grid{display:grid;grid-template-columns:repeat(7,1fr)}
    .dow,.cell{padding:10px;text-align:center;border-bottom:1px solid #f1f1f1;border-right:1px solid #f1f1f1;user-select:none}
    .grid>*:nth-child(7n){border-right:none}
    .dow{background:#fafafa;font-weight:600;font-size:.85rem}
    .cell.dis{color:#bbb;background:#fafafa;cursor:not-allowed}
    .cell.ok{background:#ecfdf5;border-bottom-color:#a7f3d0;cursor:pointer}
    .cell.bad{background:#fef2f2;border-bottom-color:#fecaca;color:#991b1b;cursor:pointer}
    .legend{display:flex;gap:12px;align-items:center;padding:0 16px 16px}
    .dot{width:12px;height:12px;border-radius:3px;display:inline-block}
    .okd{background:#ecfdf5;border:1px solid #a7f3d0}
    .badd{background:#fef2f2;border:1px solid #fecaca}
    .msg{margin:10px 16px;padding:10px;border-radius:8px;display:none}
    .ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .err{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border:none;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer}
    .btn.secondary{background:#6b7280}
    .btn.small{padding:6px 8px;font-size:.9rem}
  </style>
</head>
<body>
  <div class="topbar">
    <div>Channel Manager ‚Äî Admin Calendar</div>
    <div>
      <a href="/">Admin (All 27)</a> |
      <a href="/admin/groups">Grouped Admin</a> |
      <a href="/logout">Logout</a>
    </div>
  </div>

  <div class="wrap">
    <div class="head">
      <div>
        <div style="font-weight:700">{{ title }}</div>
        <div class="muted">Slug: {{ slug }} ‚Ä¢ Units: {{ unit_ids|join(', ') }}</div>
      </div>
      <div class="actions">
        <button class="btn secondary" onclick="window.history.back()">‚Üê Back</button>
        <a class="btn" href="/prop/{{ slug }}" target="_blank">View Public Page</a>
      </div>
    </div>

    <div id="msg" class="msg"></div>

    <div style="padding:12px 16px; display:flex; gap:8px; align-items:center;">
      <button id="syncAllBtn" class="btn" title="Fetch iCal from all OTAs and update DB">üîÑ Sync All OTAs Now</button>
      <span class="muted" id="syncStatus" style="margin-left:8px;">Last sync: ‚Äî</span>
      <div style="flex:1"></div>
      <div class="muted">Tip: Click an available (green) day to BLOCK it across all units.</div>
    </div>

    <div class="calwrap" id="calwrap"></div>
    <div class="legend">
      <span class="dot okd"></span> Available (click to BLOCK that day)
      <span class="dot badd"></span> Blocked (click to UNBLOCK that day)
    </div>
    <div class="muted" style="padding:0 16px 16px">Blocks are single-day holds (checkout next day). Click multiple days to add/remove quickly.</div>
  </div>

<script>
/*
 Admin calendar script
 - paste into admin_calendar.html replacing the old <script> block
 - Uses: /api/public/availability/<slug>  and  /api/admin/toggle_day/<slug>
*/

const slug = "{{ slug }}";
const monthsMax = 12;        // allow navigating up to 12 months
let viewOffset = 0;         // 0 = current month, 1 = next, ...
let blocked = new Set();    // YYYY-MM-DD strings
const msgEl = document.getElementById("msg");
const calwrap = document.getElementById("calwrap");

function ymd(d){ const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}` }
function addDays(dt, n){ const d=new Date(dt); d.setDate(d.getDate()+n); return d; }
function monthStartFromOffset(offset) {
  const now = new Date();
  return new Date(now.getFullYear(), now.getMonth()+offset, 1);
}

function setMsg(text, ok=true, persistMs=1800){
  if(!msgEl) return;
  if(!text){ msgEl.style.display="none"; return; }
  msgEl.textContent = text;
  msgEl.className = "msg " + (ok ? "ok" : "err");
  msgEl.style.display = "block";
  // big font and stay longer if requested
  msgEl.style.fontSize = "1.05rem";
  if(persistMs){
    setTimeout(()=>{ msgEl.style.display="none"; }, persistMs);
  }
}

function expandRanges(ranges){
  const s = new Set();
  for(const r of ranges){
    let d = new Date(r.start_date);
    const end = new Date(r.end_date);
    while(d < end){
      s.add(ymd(d));
      d = addDays(d,1);
    }
  }
  return s;
}

async function loadAvailability(){
  setMsg("Loading availability‚Ä¶", true, 0);
  try{
    const res = await fetch(`/api/public/availability/${slug}`);
    if(!res.ok){ throw new Error("Failed loading availability"); }
    const data = await res.json();
    blocked = Array.isArray(data) ? expandRanges(data) : new Set();
    setMsg("Loaded availability", true, 900);
    renderCalendars();
  }catch(err){
    console.error("loadAvailability error:", err);
    setMsg("Failed to load availability", false, 4000);
  }
}

function buildMonth(year, month){
  const wrap = document.createElement("div");
  wrap.className = "cal";
  const title = new Date(year, month, 1).toLocaleString('default', { month:'long', year:'numeric' });
  wrap.innerHTML = `<h3>${title}</h3><div class="grid"></div>`;
  const grid = wrap.querySelector(".grid");

  const dows = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  dows.forEach(d => { const el=document.createElement("div"); el.className="dow"; el.textContent=d; grid.appendChild(el); });

  const startDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();

  for(let i=0;i<startDay;i++){
    const el=document.createElement("div"); el.className="cell dis"; el.textContent=""; grid.appendChild(el);
  }

  for(let day=1; day<=daysInMonth; day++){
    const el = document.createElement("div");
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const isBlocked = blocked.has(dateStr);
    el.className = "cell " + (isBlocked ? "bad" : "ok");
    el.textContent = day;
    el.title = isBlocked ? "Click to UNBLOCK this date" : "Click to BLOCK this date";
    el.style.cursor = "pointer";
    el.addEventListener("click", () => toggleDay(dateStr, isBlocked));
    grid.appendChild(el);
  }
  return wrap;
}

function renderCalendars(){
  calwrap.innerHTML = "";
  const base = monthStartFromOffset(viewOffset);
  for(let m=0;m<2;m++){  // show two months at a time: offset, offset+1
    const dt = new Date(base.getFullYear(), base.getMonth()+m, 1);
    calwrap.appendChild(buildMonth(dt.getFullYear(), dt.getMonth()));
  }
}

async function toggleDay(dateStr, currentlyBlocked){
  // prevent double clicks
  setMsg("Working‚Ä¶", true, 0);

  const action = currentlyBlocked ? "unblock" : "block";
  try{
    const res = await fetch(`/api/admin/toggle_day/${slug}`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ date: dateStr, action })
    });
    const j = await res.json();
    if(!res.ok || !j.ok){ throw new Error(j.error || "Server failed"); }
    if(currentlyBlocked) blocked.delete(dateStr); else blocked.add(dateStr);
    renderCalendars();
    setMsg(currentlyBlocked ? `Opened ${dateStr} ‚úÖ` : `Blocked ${dateStr} ‚úÖ`, true, 2200);
  }catch(err){
    console.error("toggleDay error:", err);
    setMsg("Action failed: " + (err.message || err), false, 5000);
  }
}

/* Navigation buttons (Prev/Next) */
document.getElementById("prevMonth").addEventListener("click", () => {
  if(viewOffset <= 0) { setMsg("Cannot go earlier than current month", false, 1200); return; }
  viewOffset = Math.max(0, viewOffset - 1);
  renderCalendars();
});
document.getElementById("nextMonth").addEventListener("click", () => {
  if(viewOffset >= (monthsMax - 2)) { setMsg("Max forward months reached", false, 1200); return; }
  viewOffset = Math.min(monthsMax - 2, viewOffset + 1);
  renderCalendars();
});

/* Init */
loadAvailability();
</script>
</body>
</html>
