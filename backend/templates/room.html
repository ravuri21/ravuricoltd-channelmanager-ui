<!-- backend/templates/room.html -->
<!doctype html>
<html lang="{{ lang or 'en' }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ title }}</title>
  <link rel="stylesheet" href="/static/style.css">
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
  <header>
    <a href="/properties">← Back to properties</a>
    <h1>{{ title }}</h1>
  </header>

  <main style="max-width:900px;margin:0 auto;padding:16px;">
    <div style="display:flex;gap:16px;flex-wrap:wrap;">
      <div style="flex:1;min-width:280px;">
        <img src="{{ image_url }}" alt="{{ title }}" style="width:100%;height:260px;object-fit:cover;border-radius:8px;">
        <div style="margin-top:12px;">
          <strong>Price:</strong>
          {% if price %}
            <span id="price-val">{{ price|int }}</span> <small id="price-currency">{{ currency or 'THB' }}</small> / night
          {% else %}
            <span style="color:#888">No price yet - set one in admin</span>
          {% endif %}
        </div>
      </div>

      <div style="flex:1;min-width:320px;">
        <div id="availability-section">
          <h3>Check availability</h3>
          <p>Choose check-in and check-out dates</p>

          <label>Check-in</label>
          <input id="start_date" type="date" />

          <label style="margin-left:8px">Check-out</label>
          <input id="end_date" type="date" />

          <div id="unavailable-list" style="margin-top:10px;color:#b00;font-size:0.95rem;"></div>
        </div>

        <hr style="margin:12px 0;">

        <div id="book-form">
          <label>Your name</label>
          <input id="guest_name" type="text" placeholder="Full name" style="width:100%;padding:8px;margin-bottom:8px">

          <label>Your email</label>
          <input id="guest_email" type="email" placeholder="guest@example.com" style="width:100%;padding:8px;margin-bottom:8px">

          <!-- Stripe Card element -->
          <div id="card-element" style="margin-top:8px;padding:12px;border:1px solid #ddd;border-radius:8px"></div>
          <div id="card-errors" role="alert" style="color:#b00;margin-top:8px"></div>

          <button id="book-button" class="btn" style="margin-top:12px;background:#0069ff;color:#fff;padding:10px 14px;border-radius:8px;border:none">
            Book & pay
          </button>

          <div id="booking-result" style="margin-top:12px;font-weight:600;"></div>
        </div>
      </div>
    </div>

    <div style="margin-top:18px;color:#666;font-size:0.95rem">
      <strong>Blocked / unavailable ranges</strong>
      <ul id="blocked-ranges"></ul>
    </div>
  </main>

<script>
const slug = "{{ slug }}";
const publishableKey = "{{ publishable_key or '' }}";
const pricePerNight = {{ price or "null" }};
const currency = "{{ currency or 'THB' }}";

let blocked = []; // [{start_date, end_date, unit_id, source}, ...]

function isoToLocalDate(iso) {
  // iso like "2025-10-20"
  return iso;
}

function loadAvailability() {
  fetch(`/api/public/availability/${slug}`)
    .then(r => r.json())
    .then(data => {
      blocked = data || [];
      renderBlockedList();
    })
    .catch(err => {
      console.error("availability fetch error:", err);
    });
}

function renderBlockedList() {
  const ul = document.getElementById('blocked-ranges');
  ul.innerHTML = '';
  if (!blocked.length) {
    ul.innerHTML = '<li>None</li>';
    return;
  }
  blocked.forEach(b => {
    const li = document.createElement('li');
    li.textContent = `${b.start_date} → ${b.end_date}   (${b.source || 'ical/manual'})`;
    ul.appendChild(li);
  });
  // Also show simple message if a date input falls into a blocked range
  document.getElementById('unavailable-list').textContent = '';
}

function dateInBlocked(start, end) {
  // check if any blocked overlap [start, end)
  for (const b of blocked) {
    if (!b.start_date || !b.end_date) continue;
    // overlap if NOT (b.end <= start OR b.start >= end)
    if (!(b.end_date <= start || b.start_date >= end)) return true;
  }
  return false;
}

// Validate selected dates whenever changed
document.addEventListener('input', () => {
  const start = document.getElementById('start_date').value;
  const end = document.getElementById('end_date').value;
  if (!start || !end) return;
  if (end <= start) {
    document.getElementById('unavailable-list').textContent = "Check-out must be after check-in";
    return;
  }
  if (dateInBlocked(start, end)) {
    document.getElementById('unavailable-list').textContent = "One or more nights are unavailable. Change dates.";
    document.getElementById('book-button').disabled = true;
  } else {
    document.getElementById('unavailable-list').textContent = "";
    document.getElementById('book-button').disabled = false;
  }
});

// Stripe integration
let stripe = null;
let card = null;
function mountStripe() {
  if (!publishableKey) {
    document.getElementById('card-errors').textContent = "Payment not available (publishable key missing)";
    document.getElementById('book-button').disabled = true;
    return;
  }
  stripe = Stripe(publishableKey);
  const elements = stripe.elements();
  card = elements.create('card');
  card.mount('#card-element');
  card.on('change', function(ev) {
    const err = document.getElementById('card-errors');
    err.textContent = ev.error ? ev.error.message : '';
  });
}

async function createPaymentIntent(start, end) {
  const resp = await fetch(`/api/public/create_intent/${slug}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({start_date:start, end_date:end})
  });
  return resp.json();
}

document.getElementById('book-button').addEventListener('click', async function(e) {
  e.preventDefault();
  const name = document.getElementById('guest_name').value.trim();
  const email = document.getElementById('guest_email').value.trim();
  const start = document.getElementById('start_date').value;
  const end = document.getElementById('end_date').value;

  if (!start || !end) { alert('Choose check-in and check-out'); return; }
  if (end <= start) { alert('Check-out must be after check-in'); return; }
  if (!name || !email) { alert('Enter name and email'); return; }
  if (dateInBlocked(start, end)) { alert('Selected dates unavailable'); return; }

  // Create PaymentIntent
  const createResp = await createPaymentIntent(start, end);
  if (createResp.error) {
    alert("Payment creation failed: " + createResp.error);
    return;
  }
  const clientSecret = createResp.client_secret;
  if (!clientSecret) {
    alert("Payment creation returned no client_secret");
    return;
  }

  // Confirm card payment
  document.getElementById('book-button').disabled = true;
  document.getElementById('booking-result').textContent = 'Processing payment...';

  const {error, paymentIntent} = await stripe.confirmCardPayment(clientSecret, {
    payment_method: {
      card: card,
      billing_details: {name: name, email: email}
    }
  });

  if (error) {
    document.getElementById('card-errors').textContent = error.message || 'Payment failed';
    document.getElementById('book-button').disabled = false;
    document.getElementById('booking-result').textContent = '';
    return;
  }

  if (paymentIntent && paymentIntent.status === 'succeeded') {
    // Payment succeeded — call your booking endpoint to record & block dates
    const bookResp = await fetch(`/api/public/book_group/${slug}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({start_date:start, end_date:end, name:name, email:email})
    });
    const bookJson = await bookResp.json();
    if (bookJson.ok) {
      document.getElementById('booking-result').innerHTML = '✅ Booking confirmed — dates blocked.';
      // Refresh availability
      loadAvailability();
    } else {
      document.getElementById('booking-result').innerHTML = '⚠️ Booking saved on payment but failed to record: ' + (bookJson.error || JSON.stringify(bookJson));
    }
  } else {
    document.getElementById('booking-result').textContent = 'Payment not completed: ' + (paymentIntent ? paymentIntent.status : 'unknown');
    document.getElementById('book-button').disabled = false;
  }
});

window.addEventListener('load', function() {
  loadAvailability();
  mountStripe();
});
</script>

<style>
  label{display:block;margin-top:8px;font-weight:600}
  input[type=date], input[type=text], input[type=email]{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;margin-top:6px}
  .btn{display:inline-block;padding:10px 14px}
</style>

</body>
</html>
