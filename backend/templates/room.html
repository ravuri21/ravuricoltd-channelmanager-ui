<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --blue:#0070f3; --blue-d:#005ad1; --bg:#f6f8fa; --text:#222; --muted:#555; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, Arial, sans-serif; margin:0; background:var(--bg); color:var(--text); }
    .container { max-width: 640px; margin: 32px auto; background:#fff; border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,.08); overflow:hidden; }
    .hero img { width:100%; height:240px; object-fit:cover; display:block; }
    .content { padding:20px; }
    h1 { font-size:1.4rem; margin:0 0 8px; }
    p.desc { color:var(--muted); margin:0 0 16px; }
    label { display:block; font-size:.9rem; margin:10px 0 4px; color:#333; }
    input, button { width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; font-size:1rem; }
    input:focus { outline:none; border-color: var(--blue); }
    button { background:var(--blue); color:#fff; border:none; font-weight:600; margin-top:12px; cursor:pointer; }
    button:hover { background:var(--blue-d); }
    button[disabled] { opacity:.7; cursor:not-allowed; }
    .footer { text-align:center; font-size:.8rem; color:#777; margin:14px 0 10px; }
    .msg { margin-top:10px; padding:10px; border-radius:8px; font-size:.95rem; }
    .ok { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .err { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
  </style>
</head>
<body>
  <div class="container">
    <div class="hero">
      <!-- You can replace this with a real photo URL per unit later -->
      <img src="https://source.unsplash.com/featured/?pattaya,villa" alt="Property photo">
    </div>
    <div class="content">
      <h1>{{ title }}</h1>
      <p class="desc">Enjoy a relaxing stay — private, comfortable, and centrally located in Pattaya. Choose your dates and send a booking request.</p>

      <form id="bookForm" novalidate>
        <label>Check-in</label>
        <input id="start" type="date" required>

        <label>Check-out</label>
        <input id="end" type="date" required>

        <label>Your Name</label>
        <input id="name" type="text" placeholder="Full name" required>

        <label>Your Email</label>
        <input id="email" type="email" placeholder="Email address" required>

        <button id="submitBtn" type="submit">Book &amp; Pay (test)</button>
      </form>

      <div id="msg" class="msg" style="display:none;"></div>
      <div class="footer">Powered by RavuriCo Ltd • Stripe test mode</div>
    </div>
  </div>

  <script>
  // --- Set min dates to today (works on iPhone/Safari too) ---
  (function setMinDates(){
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    const iso = `${yyyy}-${mm}-${dd}`;
    const start = document.getElementById("start");
    const end = document.getElementById("end");
    start.min = iso;
    end.min = iso;
  })();

  const form = document.getElementById("bookForm");
  const msg  = document.getElementById("msg");
  const btn  = document.getElementById("submitBtn");

  function showMsg(text, ok=false){
    msg.textContent = text;
    msg.className = ok ? "msg ok" : "msg err";
    msg.style.display = "block";
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    msg.style.display = "none";

    const data = {
      start_date: document.getElementById("start").value,
      end_date:   document.getElementById("end").value,
      name:       document.getElementById("name").value.trim(),
      email:      document.getElementById("email").value.trim()
    };

    // Front-end validation
    if (!data.start_date || !data.end_date || !data.name || !data.email) {
      showMsg("❌ Please fill all fields.");
      return;
    }
    if (data.end_date <= data.start_date) {
      showMsg("❌ Check-out must be after check-in.");
      return;
    }

    // Build API URL: /api/public/book/<unit_id>
    const apiUrl = location.pathname.replace("/r/","/api/public/book/");

    btn.disabled = true;
    const original = btn.textContent;
    btn.textContent = "Processing…";

    try {
      const res = await fetch(apiUrl, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(data)
      });

      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch(_) {}

      if (!res.ok) {
        showMsg("❌ " + (json && json.error ? json.error : `Server error (${res.status}). ${text.slice(0,120)}`));
      } else if (json && json.ok) {
        showMsg("✅ Booking request received — dates blocked (test).", true);
        form.reset();
      } else {
        showMsg("❌ Unexpected response: " + text.slice(0,200));
      }
    } catch (err) {
      showMsg("❌ Network error: " + (err && err.message ? err.message : err));
    } finally {
      btn.disabled = false;
      btn.textContent = original;
    }
  });
  </script>
</body>
</html>
