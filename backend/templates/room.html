<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --blue:#0070f3; --blue-d:#005ad1; --bg:#f6f8fa; --text:#222; --muted:#555; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, Arial, sans-serif; margin:0; background:var(--bg); color:var(--text); }
    .container { max-width: 820px; margin: 24px auto; background:#fff; border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,.08); overflow:hidden; }
    .hero img { width:100%; height:280px; object-fit:cover; display:block; }
    .content { padding:20px; display:grid; grid-template-columns: 1fr 320px; gap:24px; }
    @media (max-width: 860px){ .content { grid-template-columns: 1fr; } }
    h1 { font-size:1.3rem; margin:0 0 6px; }
    .price { font-weight:700; margin:0 0 14px; color:#111; }
    .muted { color:var(--muted); }
    label { display:block; font-size:.9rem; margin:10px 0 4px; color:#333; }
    input, button { width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; font-size:1rem; }
    input:focus { outline:none; border-color: var(--blue); }
    button { background:var(--blue); color:#fff; border:none; font-weight:600; margin-top:12px; cursor:pointer; }
    button:hover { background:var(--blue-d); }
    button[disabled] { opacity:.7; cursor:not-allowed; }
    .footer { text-align:center; font-size:.8rem; color:#777; margin:16px 0 10px; }
    .msg { margin-top:10px; padding:10px; border-radius:8px; font-size:.95rem; }
    .ok { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .err { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
    .panel { background:#fafafa; border:1px solid #eee; border-radius:10px; padding:14px; }
    ul.ranges { padding-left: 18px; margin: 8px 0; }
    .gallery { display:flex; gap:8px; overflow:auto; margin-top:10px; }
    .gallery img { width:120px; height:80px; object-fit:cover; border-radius:8px; border:1px solid #eee; }
  </style>
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
  <div class="container">
    <div class="hero">
      <img src="{{ image_url or 'https://source.unsplash.com/featured/?pattaya,villa' }}" alt="Property photo">
    </div>

    <div class="content">
      <div>
        <h1>{{ title }}</h1>
        {% if price %}
          <div class="price">฿ {{ '%.0f'|format(price) }} <span class="muted">/ night {{ currency or 'THB' }}</span></div>
        {% else %}
          <div class="price">Contact for price</div>
        {% endif %}
        <p class="muted">Enjoy a relaxing stay — private, comfortable, and centrally located in Pattaya.</p>

        <div id="gallery" class="gallery" style="display:none;"></div>

        <div class="panel" id="availPanel" style="display:none;">
          <strong>Booked dates</strong>
          <ul id="ranges" class="ranges"></ul>
        </div>

        <div class="footer">Powered by RavuriCo Ltd • Stripe test mode</div>
      </div>

      <div>
        <form id="bookForm" class="panel" novalidate>
          <label>Check-in</label>
          <input id="start" type="date" required>
          <label>Check-out</label>
          <input id="end" type="date" required>
          <label>Your Name</label>
          <input id="name" type="text" placeholder="Full name" required>
          <label>Your Email</label>
          <input id="email" type="email" placeholder="Email address" required>

          <div id="cardWrap" style="display:none;">
            <label>Card</label>
            <div id="card-element" style="padding:10px;border:1px solid #ddd;border-radius:8px;"></div>
          </div>

          <button id="submitBtn" type="submit">Book & Pay (test)</button>
          <div id="msg" class="msg" style="display:none;"></div>
        </form>
      </div>
    </div>
  </div>

  <script>
  const path = location.pathname;
  const isGroup = path.startsWith("/prop/");
  const slug = isGroup ? path.split("/").pop() : null;

  async function loadAvailability(){
    if(!isGroup) return;
    try{
      const r = await fetch("/api/public/availability/" + slug);
      const data = await r.json();
      if(Array.isArray(data) && data.length){
        document.getElementById("availPanel").style.display = "block";
        const ul = document.getElementById("ranges");
        ul.innerHTML = data.map(b => `<li>${b.start_date} → ${b.end_date} <span class="muted">(${b.source})</span></li>`).join("");
      }
    }catch(_){}
  }

  function loadGallery(){ /* hook for future gallery support */ }

  // Stripe
  let stripe, card;
  (function initStripe(){
    if(!isGroup) return;
    const pk = "{{ publishable_key or '' }}".trim();
    if(!pk){ return; }
    stripe = Stripe(pk);
    const elements = stripe.elements();
    card = elements.create('card');
    card.mount('#card-element');
    document.getElementById("cardWrap").style.display = "block";
  })();

  function showMsg(text, ok=false){
    const m = document.getElementById("msg");
    m.textContent = text;
    m.className = ok ? "msg ok" : "msg err";
    m.style.display = "block";
  }

  (function setMinDates(){
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    const iso = `${yyyy}-${mm}-${dd}`;
    start.min = iso; end.min = iso;
  })();

  document.getElementById("bookForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const startDate = document.getElementById("start").value;
    const endDate   = document.getElementById("end").value;
    const name      = document.getElementById("name").value.trim();
    const email     = document.getElementById("email").value.trim();

    if(!startDate || !endDate || !name || !email){
      showMsg("❌ Please fill all fields."); return;
    }
    if(endDate <= startDate){
      showMsg("❌ Check-out must be after check-in."); return;
    }

    const btn = document.getElementById("submitBtn");
    const original = btn.textContent;
    btn.disabled = true; btn.textContent = "Processing…";
    document.getElementById("msg").style.display = "none";

    try {
      if(isGroup && "{{ publishable_key or '' }}"){
        // 1) Create PaymentIntent
        const piRes = await fetch("/api/public/create_intent/" + slug, {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ start_date: startDate, end_date: endDate })
        });
        const pi = await piRes.json();
        if(!piRes.ok || !pi.ok){ throw new Error(pi.error || "Failed to create payment"); }

        // 2) Confirm card
        const {error, paymentIntent} = await stripe.confirmCardPayment(pi.client_secret, {
          payment_method: { card, billing_details: { name, email } }
        });
        if(error){ throw error; }
        if(paymentIntent.status !== "succeeded"){
          throw new Error("Payment not completed");
        }
      }

      // 3) Block dates
      let apiUrl;
      if(isGroup){
        apiUrl = "/api/public/book_group/" + slug;
      }else if(path.startsWith("/r/")){
        apiUrl = path.replace("/r/","/api/public/book/");
      }else{
        apiUrl = "/api/public/book";
      }

      const res = await fetch(apiUrl, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ start_date: startDate, end_date: endDate, name, email })
      });
      const j = await res.json();
      if(res.ok && j.ok){
        showMsg("✅ Booking confirmed — dates blocked.", true);
        loadAvailability();
      }else{
        throw new Error(j.error || "Unknown error");
      }
    } catch(err){
      showMsg("❌ " + (err.message || err));
    } finally {
      btn.disabled = false; btn.textContent = original;
    }
  });

  loadAvailability();
  loadGallery();
  </script>
</body>
</html>
